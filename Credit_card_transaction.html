<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>ba570d75d1b34b9f9a82cb5a8a46b067</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<section id="fraud-detection-of-credit-cart-transaction"
class="cell markdown">
<h1>Fraud Detection of Credit Cart Transaction</h1>
</section>
<section id="1-loading-data" class="cell markdown">
<h2>1. Loading data</h2>
</section>
<div class="cell code" data-execution_count="77">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymysql </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> chi2_contingency</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">&#39;ignore&#39;</span>)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="78">
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Befor runnning the code please upload the file &quot;transactions.txt &quot; to your jupyter environment to run the code.</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>data<span class="op">=</span>[json.loads(line) <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">open</span>(<span class="st">&#39;transactions.txt&#39;</span>,<span class="st">&#39;r&#39;</span>)]</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#importing with dictionary form from JSON file</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>df<span class="op">=</span>pd.DataFrame.from_dict(data)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#making into Dataframe form from dictionary form</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>df<span class="op">=</span>df.replace(<span class="vs">r&#39;^\s*$&#39;</span>, np.nan, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Replace empty to NaN</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>Data loaded into python pandas data frame from original JSON
format.</p>
</div>
<div class="cell code" data-execution_count="79">
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>pd.options.display.max_rows<span class="op">=</span><span class="dv">300</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>pd.options.display.max_columns<span class="op">=</span><span class="dv">60</span> <span class="co">#To see all the columns</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>df.head(<span class="dv">2</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="79">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>accountNumber</th>
      <th>customerId</th>
      <th>creditLimit</th>
      <th>availableMoney</th>
      <th>transactionDateTime</th>
      <th>transactionAmount</th>
      <th>merchantName</th>
      <th>acqCountry</th>
      <th>merchantCountryCode</th>
      <th>posEntryMode</th>
      <th>posConditionCode</th>
      <th>merchantCategoryCode</th>
      <th>currentExpDate</th>
      <th>accountOpenDate</th>
      <th>dateOfLastAddressChange</th>
      <th>cardCVV</th>
      <th>enteredCVV</th>
      <th>cardLast4Digits</th>
      <th>transactionType</th>
      <th>echoBuffer</th>
      <th>currentBalance</th>
      <th>merchantCity</th>
      <th>merchantState</th>
      <th>merchantZip</th>
      <th>cardPresent</th>
      <th>posOnPremises</th>
      <th>recurringAuthInd</th>
      <th>expirationDateKeyInMatch</th>
      <th>isFraud</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>737265056</td>
      <td>737265056</td>
      <td>5000.0</td>
      <td>5000.0</td>
      <td>2016-08-13T14:27:32</td>
      <td>98.55</td>
      <td>Uber</td>
      <td>US</td>
      <td>US</td>
      <td>02</td>
      <td>01</td>
      <td>rideshare</td>
      <td>06/2023</td>
      <td>2015-03-14</td>
      <td>2015-03-14</td>
      <td>414</td>
      <td>414</td>
      <td>1803</td>
      <td>PURCHASE</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>False</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>737265056</td>
      <td>737265056</td>
      <td>5000.0</td>
      <td>5000.0</td>
      <td>2016-10-11T05:05:54</td>
      <td>74.51</td>
      <td>AMC #191138</td>
      <td>US</td>
      <td>US</td>
      <td>09</td>
      <td>01</td>
      <td>entertainment</td>
      <td>02/2024</td>
      <td>2015-03-14</td>
      <td>2015-03-14</td>
      <td>486</td>
      <td>486</td>
      <td>767</td>
      <td>PURCHASE</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>True</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell code" data-execution_count="80">
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.shape)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Printing out the data structure</span></span></code></pre></div>
<div class="output stream stdout">
<pre><code>(786363, 29)
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>There are 786363 transaction cases (rows) with 29 columns</p>
</div>
<section id="2-summary-statistics-for-the-features"
class="cell markdown">
<h2>2. Summary statistics for the features</h2>
</section>
<div class="cell markdown">
<p>First, there will be handling of missing values in the data.</p>
</div>
<div class="cell code" data-execution_count="81">
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df.info() <span class="co">#skimming datatype and missing</span></span></code></pre></div>
<div class="output stream stdout">
<pre><code>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;

RangeIndex: 786363 entries, 0 to 786362

Data columns (total 29 columns):

 #   Column                    Non-Null Count   Dtype  

---  ------                    --------------   -----  

 0   accountNumber             786363 non-null  object 

 1   customerId                786363 non-null  object 

 2   creditLimit               786363 non-null  float64

 3   availableMoney            786363 non-null  float64

 4   transactionDateTime       786363 non-null  object 

 5   transactionAmount         786363 non-null  float64

 6   merchantName              786363 non-null  object 

 7   acqCountry                781801 non-null  object 

 8   merchantCountryCode       785639 non-null  object 

 9   posEntryMode              782309 non-null  object 

 10  posConditionCode          785954 non-null  object 

 11  merchantCategoryCode      786363 non-null  object 

 12  currentExpDate            786363 non-null  object 

 13  accountOpenDate           786363 non-null  object 

 14  dateOfLastAddressChange   786363 non-null  object 

 15  cardCVV                   786363 non-null  object 

 16  enteredCVV                786363 non-null  object 

 17  cardLast4Digits           786363 non-null  object 

 18  transactionType           785665 non-null  object 

 19  echoBuffer                0 non-null       float64

 20  currentBalance            786363 non-null  float64

 21  merchantCity              0 non-null       float64

 22  merchantState             0 non-null       float64

 23  merchantZip               0 non-null       float64

 24  cardPresent               786363 non-null  bool   

 25  posOnPremises             0 non-null       float64

 26  recurringAuthInd          0 non-null       float64

 27  expirationDateKeyInMatch  786363 non-null  bool   

 28  isFraud                   786363 non-null  bool   

dtypes: bool(3), float64(10), object(16)

memory usage: 158.2+ MB
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="82">
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df.isna().<span class="bu">sum</span>() <span class="co">#count number of missing values for each column</span></span></code></pre></div>
<div class="output execute_result" data-execution_count="82">
<pre><code>accountNumber                    0
customerId                       0
creditLimit                      0
availableMoney                   0
transactionDateTime              0
transactionAmount                0
merchantName                     0
acqCountry                    4562
merchantCountryCode            724
posEntryMode                  4054
posConditionCode               409
merchantCategoryCode             0
currentExpDate                   0
accountOpenDate                  0
dateOfLastAddressChange          0
cardCVV                          0
enteredCVV                       0
cardLast4Digits                  0
transactionType                698
echoBuffer                  786363
currentBalance                   0
merchantCity                786363
merchantState               786363
merchantZip                 786363
cardPresent                      0
posOnPremises               786363
recurringAuthInd            786363
expirationDateKeyInMatch         0
isFraud                          0
dtype: int64</code></pre>
</div>
</div>
<div class="cell markdown">
<p>Six features only have NaN for every row that is not informative. So,
those columns will be dropped.</p>
</div>
<div class="cell code" data-execution_count="83">
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df<span class="op">=</span>df.drop([<span class="st">&#39;echoBuffer&#39;</span>, <span class="st">&#39;merchantCity&#39;</span>,<span class="st">&#39;merchantState&#39;</span>,<span class="st">&#39;merchantZip&#39;</span>,<span class="st">&#39;posOnPremises&#39;</span>,<span class="st">&#39;recurringAuthInd&#39;</span>], axis<span class="op">=</span><span class="dv">1</span>) <span class="co"># dropping six columns</span></span></code></pre></div>
</div>
<div class="cell code" data-execution_count="84">
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>df.describe() <span class="co">#Summary statistics for continuous variables</span></span></code></pre></div>
<div class="output execute_result" data-execution_count="84">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>creditLimit</th>
      <th>availableMoney</th>
      <th>transactionAmount</th>
      <th>currentBalance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>786363.000000</td>
      <td>786363.000000</td>
      <td>786363.000000</td>
      <td>786363.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>10759.464459</td>
      <td>6250.725369</td>
      <td>136.985791</td>
      <td>4508.739089</td>
    </tr>
    <tr>
      <th>std</th>
      <td>11636.174890</td>
      <td>8880.783989</td>
      <td>147.725569</td>
      <td>6457.442068</td>
    </tr>
    <tr>
      <th>min</th>
      <td>250.000000</td>
      <td>-1005.630000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>5000.000000</td>
      <td>1077.420000</td>
      <td>33.650000</td>
      <td>689.910000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>7500.000000</td>
      <td>3184.860000</td>
      <td>87.900000</td>
      <td>2451.760000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>15000.000000</td>
      <td>7500.000000</td>
      <td>191.480000</td>
      <td>5291.095000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>50000.000000</td>
      <td>50000.000000</td>
      <td>2011.540000</td>
      <td>47498.810000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell markdown">
<p>These are summary statistics of the continuous variables that are
monetary values. I can check that the limits of credit are under
\$50,000 dollars and usually around \$10,000. These features do not have
missing values, so there is no need to conduct missing imputations for
them.</p>
</div>
<div class="cell markdown">
<p>For the categorical features, I will treat them as one of the
categories 'Unknown'.</p>
</div>
<div class="cell code" data-execution_count="85">
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df<span class="op">=</span>df.replace(np.nan,<span class="st">&#39;Unknown&#39;</span>) <span class="co"># change NaN to Unknown </span></span></code></pre></div>
</div>
<div class="cell code" data-execution_count="86">
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df.nunique()</span></code></pre></div>
<div class="output execute_result" data-execution_count="86">
<pre><code>accountNumber                 5000
customerId                    5000
creditLimit                     10
availableMoney              521916
transactionDateTime         776637
transactionAmount            66038
merchantName                  2490
acqCountry                       5
merchantCountryCode              5
posEntryMode                     6
posConditionCode                 4
merchantCategoryCode            19
currentExpDate                 165
accountOpenDate               1820
dateOfLastAddressChange       2184
cardCVV                        899
enteredCVV                     976
cardLast4Digits               5246
transactionType                  4
currentBalance              487318
cardPresent                      2
expirationDateKeyInMatch         2
isFraud                          2
dtype: int64</code></pre>
</div>
</div>
<div class="cell markdown">
<p>The data is 5000 customer IDs, and the number gives the impression
that the data is intentionally cut into 5000 for the convenience of this
data challenge. We need to check whether the id and account number are
the same thing. Also, We need to see categorical variables that might be
informative for the modeling.</p>
</div>
<div class="cell code" data-execution_count="87">
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>(df.accountNumber<span class="op">!=</span>df.customerId).<span class="bu">sum</span>() <span class="co">#total number of rows for the mismatch between those columns</span></span></code></pre></div>
<div class="output execute_result" data-execution_count="87">
<pre><code>0</code></pre>
</div>
</div>
<div class="cell markdown">
<p>The counts of difference in accountNumber and customerId is zero, so
I can consider them as a same feature for this data.</p>
</div>
<div class="cell code" data-execution_count="88">
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">&#39;acqCountry&#39;</span>]].value_counts()</span></code></pre></div>
<div class="output execute_result" data-execution_count="88">
<pre><code>acqCountry
US            774709
Unknown         4562
MEX             3130
CAN             2424
PR              1538
dtype: int64</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="89">
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">&#39;cardPresent&#39;</span>]].value_counts()</span></code></pre></div>
<div class="output execute_result" data-execution_count="89">
<pre><code>cardPresent
False          433495
True           352868
dtype: int64</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="90">
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">&#39;posEntryMode&#39;</span>]].value_counts()</span></code></pre></div>
<div class="output execute_result" data-execution_count="90">
<pre><code>posEntryMode
05              315035
09              236481
02              195934
90               19576
80               15283
Unknown           4054
dtype: int64</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="91">
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">&#39;transactionType&#39;</span>]].value_counts()</span></code></pre></div>
<div class="output execute_result" data-execution_count="91">
<pre><code>transactionType     
PURCHASE                745193
REVERSAL                 20303
ADDRESS_VERIFICATION     20169
Unknown                    698
dtype: int64</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="92">
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">&#39;isFraud&#39;</span>]].value_counts()</span></code></pre></div>
<div class="output execute_result" data-execution_count="92">
<pre><code>isFraud
False      773946
True        12417
dtype: int64</code></pre>
</div>
</div>
<div class="cell markdown">
<p>These are value counts for each category for some categorical
variables in the data. The isFraud is the target variable for predictive
modeling in the later part. I can see that there are lot more False than
True.</p>
</div>
<section id="3-exploratory-analysis" class="cell markdown">
<h2>3. Exploratory analysis</h2>
</section>
<section id="transaction-amount-by-transaction-type"
class="cell markdown">
<h3>transaction amount by transaction type.</h3>
</section>
<div class="cell code" data-execution_count="93">
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df2<span class="op">=</span>df.copy()</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Copy from df in Q1</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>df2[<span class="st">&#39;transactionAmount&#39;</span>].hist(by<span class="op">=</span>df2[<span class="st">&#39;transactionType&#39;</span>],bins<span class="op">=</span><span class="dv">50</span>,figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">6</span>)) <span class="co"># histogram by transaction type</span></span></code></pre></div>
<div class="output execute_result" data-execution_count="93">
<pre><code>array([[&lt;AxesSubplot:title={&#39;center&#39;:&#39;ADDRESS_VERIFICATION&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;PURCHASE&#39;}&gt;],
       [&lt;AxesSubplot:title={&#39;center&#39;:&#39;REVERSAL&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;Unknown&#39;}&gt;]], dtype=object)</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_8a8eb62ffdfe4e549465fa0e38037da9/c037267692cecad99dad4ad1c0e8537b9b55c6f1.png" /></p>
</div>
</div>
<div class="cell code" data-execution_count="94">
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>df2[[<span class="st">&#39;transactionType&#39;</span>]].value_counts()</span></code></pre></div>
<div class="output execute_result" data-execution_count="94">
<pre><code>transactionType     
PURCHASE                745193
REVERSAL                 20303
ADDRESS_VERIFICATION     20169
Unknown                    698
dtype: int64</code></pre>
</div>
</div>
<div class="cell markdown">
<p>There are only 698 unknown transactions, so it seems almost
ignorable. The address verification is not an actual transaction that
money flows. Purchases are mostly under \$500, and it is skewed to the
right. Most of the transactions are happening in cheap buying. Reversal
of the purchase is also similar to the purchase with slightly more
expensive transactions included.</p>
</div>
<div class="cell markdown">
<p>It is natural to think that fraud transactions will be more pricy
than normal transactions. To check this hypothesis, I compared
transactionAmount between fraud and non-fraud transactions.</p>
</div>
<div class="cell code" data-execution_count="96">
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>df2[<span class="st">&#39;transactionAmount&#39;</span>].hist(by<span class="op">=</span>df2[<span class="st">&#39;isFraud&#39;</span>],bins<span class="op">=</span><span class="dv">100</span>) <span class="co">#histogram of transaction amount group by isFraud</span></span></code></pre></div>
<div class="output execute_result" data-execution_count="96">
<pre><code>array([&lt;AxesSubplot:title={&#39;center&#39;:&#39;False&#39;}&gt;,
       &lt;AxesSubplot:title={&#39;center&#39;:&#39;True&#39;}&gt;], dtype=object)</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_8a8eb62ffdfe4e549465fa0e38037da9/baaf5f29cb1e8bb46ab31cb03e4443d21c222baa.png" /></p>
</div>
</div>
<div class="cell code" data-execution_count="97">
<div class="sourceCode" id="cb33"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_frauds(data,par):</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    nfrd <span class="op">=</span> data.loc[data[<span class="st">&quot;isFraud&quot;</span>] <span class="op">==</span> <span class="dv">0</span>][par].rename(<span class="st">&quot;NoFraud&quot;</span>).describe()</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    frd <span class="op">=</span> data.loc[data[<span class="st">&quot;isFraud&quot;</span>] <span class="op">==</span> <span class="dv">1</span>][par].rename(<span class="st">&quot;Fraud&quot;</span>).describe()</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    comb <span class="op">=</span> nfrd.to_frame().join(frd.to_frame())</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> comb</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co">#A functioon to show summary statistics of transaction amount for fraud and no fraud cases.</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>compare_frauds(df2,<span class="st">&quot;transactionAmount&quot;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="97">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NoFraud</th>
      <th>Fraud</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>773946.000000</td>
      <td>12417.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>135.570249</td>
      <td>225.215905</td>
    </tr>
    <tr>
      <th>std</th>
      <td>146.525305</td>
      <td>189.551393</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>33.190000</td>
      <td>86.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>86.760000</td>
      <td>176.980000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>189.390000</td>
      <td>311.460000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>2011.540000</td>
      <td>1608.350000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell markdown">
<p>As expected, Fraud transactions tend to have greater transaction
amounts.</p>
</div>
<div class="cell markdown">
<p>It is possible to have different transaction trend in different time.
To check the effect of hour, day, month and year, I will preprocess
transactionDateTime to separate column for each of time unit.</p>
</div>
<div class="cell code" data-execution_count="99">
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>df2[<span class="st">&#39;hour&#39;</span>]<span class="op">=</span>pd.DatetimeIndex(df2[<span class="st">&#39;transactionDateTime&#39;</span>]).hour</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>df2[<span class="st">&#39;dayofweek&#39;</span>]<span class="op">=</span>pd.DatetimeIndex(df2[<span class="st">&#39;transactionDateTime&#39;</span>]).dayofweek</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>df2[<span class="st">&#39;month&#39;</span>]<span class="op">=</span>pd.DatetimeIndex(df2[<span class="st">&#39;transactionDateTime&#39;</span>]).month</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>df2[<span class="st">&#39;year&#39;</span>]<span class="op">=</span>pd.DatetimeIndex(df2[<span class="st">&#39;transactionDateTime&#39;</span>]).year</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co">#Extracting each of time unit for&#39;transactionDateTime&#39;</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co">#fig, axs=plt.subplots(5,1,sharey=True,tight_layout=True)</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">&quot;figure.figsize&quot;</span>] <span class="op">=</span> [<span class="dv">8</span>, <span class="dv">4</span>]</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">&quot;figure.autolayout&quot;</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="co">#2x2 plots for 4 histograms</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>df2.hist(<span class="st">&#39;year&#39;</span>, ax<span class="op">=</span>axes[<span class="dv">0</span>,<span class="dv">0</span>])</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>df2.hist(<span class="st">&#39;month&#39;</span>, ax<span class="op">=</span>axes[<span class="dv">0</span>,<span class="dv">1</span>],bins<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>df2.hist(<span class="st">&#39;dayofweek&#39;</span>, ax<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">0</span>],bins<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>df2.hist(<span class="st">&#39;hour&#39;</span>, ax<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">1</span>],bins<span class="op">=</span><span class="dv">24</span>)</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_8a8eb62ffdfe4e549465fa0e38037da9/20d9e09aa0b6d241acb5ef7703f33336a2b2a627.png" /></p>
</div>
</div>
<div class="cell markdown">
<p>It shows that the data is transaction data for 2016. There is some
difference at different times. Will it be related to the fraud? I will
check transaction distribution at different hours for non-fraud and
fraud transactions.</p>
</div>
<div class="cell code" data-execution_count="100">
<div class="sourceCode" id="cb35"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">7</span>))</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> a <span class="kw">in</span> ax:</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    a.set_xticks(<span class="bu">range</span>(<span class="dv">24</span>))</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>df2.loc[df3[<span class="st">&quot;isFraud&quot;</span>] <span class="op">==</span> <span class="dv">0</span>][<span class="st">&quot;hour&quot;</span>].hist(bins<span class="op">=</span>np.arange(<span class="dv">24</span>)<span class="op">-</span><span class="fl">0.5</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>], grid<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>df2.loc[df3[<span class="st">&quot;isFraud&quot;</span>] <span class="op">==</span> <span class="dv">1</span>][<span class="st">&quot;hour&quot;</span>].hist(bins<span class="op">=</span>np.arange(<span class="dv">24</span>)<span class="op">-</span><span class="fl">0.5</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>], grid<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].title.set_text(<span class="st">&quot;Non Fraud Transactions&quot;</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].title.set_text(<span class="st">&quot;Fraud Transactions&quot;</span>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(hspace<span class="op">=</span><span class="fl">0.3</span>)</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_8a8eb62ffdfe4e549465fa0e38037da9/7cca473ff8233009aa14bf22385f4bce6be0a080.png" /></p>
</div>
</div>
<div class="cell markdown">
<p>We can see that fraud transactions tend to be less uniform across the
transactions. This might work as a good predictor for Fraud
detection.</p>
</div>
<div class="cell markdown">
<p>One feature that seems interesting was cardPresent, because typical
fraud happens when the card is still in one's hands. We may check the
transaction amount for cardPresent and non-present depending on fraud
and non-fraud transactions.</p>
</div>
<div class="cell code" data-execution_count="101">
<div class="sourceCode" id="cb36"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">#pvoting to draw bar graph with two groups</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>df_pivot <span class="op">=</span> pd.pivot_table(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    df2, </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    values<span class="op">=</span><span class="st">&quot;transactionAmount&quot;</span>,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">&quot;isFraud&quot;</span>,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span><span class="st">&quot;cardPresent&quot;</span>, </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    aggfunc<span class="op">=</span>np.mean</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>) <span class="co">#np.mean for mean transaction amount</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> df_pivot.plot(kind<span class="op">=</span><span class="st">&quot;bar&quot;</span>)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> ax.get_figure()</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>fig.set_size_inches(<span class="dv">7</span>, <span class="dv">6</span>)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">&quot;isFraud&quot;</span>)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">&quot;transactionAmount&quot;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="101">
<pre><code>Text(0, 0.5, &#39;transactionAmount&#39;)</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_8a8eb62ffdfe4e549465fa0e38037da9/85101789ff4d26d844f1022b275b1278606a672d.png" /></p>
</div>
</div>
<div class="cell markdown">
<p>For fraud transactions, the mean amount of transactions was much
higher when the card was not present.</p>
</div>
<section id="4-data-wragling" class="cell markdown">
<h2>4. Data wragling</h2>
</section>
<section id="reversed-transaction" class="cell markdown">
<h3>Reversed transaction</h3>
</section>
<div class="cell markdown">
<p>Here are codes to create an indicator column for reversed
transactions. The logic is explained in comments inside the code.</p>
</div>
<div class="cell code" data-execution_count="102">
<div class="sourceCode" id="cb38"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df3<span class="op">=</span>df2.copy() <span class="co">#copy data from q2</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>df3[<span class="st">&#39;indexer&#39;</span>]<span class="op">=</span>df3.index <span class="co">#</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>df3[<span class="st">&#39;Rev_indicator&#39;</span>]<span class="op">=</span><span class="st">&quot;NO&quot;</span> <span class="co">#df3 is the data frame that will get the indicator column</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>df4<span class="op">=</span>df3.copy() <span class="co">#temporary dataframe to get index for the rows of interest</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>df4_rev<span class="op">=</span>df4[(df4[<span class="st">&#39;transactionType&#39;</span>]<span class="op">==</span><span class="st">&#39;REVERSAL&#39;</span>)] <span class="co"># subset for reversal data</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>df4 <span class="op">=</span> df4.merge(df4_rev, how<span class="op">=</span><span class="st">&#39;left&#39;</span>, left_on<span class="op">=</span>[<span class="st">&quot;customerId&quot;</span>, <span class="st">&quot;transactionAmount&quot;</span>,<span class="st">&quot;merchantName&quot;</span>], right_on<span class="op">=</span>[<span class="st">&quot;customerId&quot;</span>, <span class="st">&quot;transactionAmount&quot;</span>,<span class="st">&quot;merchantName&quot;</span>])</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co">#Joining back the reversal subset to the full data to find reversal relevant rows</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>df_time_filtered<span class="op">=</span>df4[df4.transactionDateTime_x<span class="op">&lt;</span>df4.transactionDateTime_y]</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co">#use only for the transactions happened earlier than the reversal transaction.</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>df_pur_filtered<span class="op">=</span>df_time_filtered[df_time_filtered[<span class="st">&#39;transactionType_x&#39;</span>]<span class="op">==</span><span class="st">&#39;PURCHASE&#39;</span>]</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co">#subsetting purchase data only among reversal-related data</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>df_maxtime<span class="op">=</span>df_pur_filtered.groupby(by<span class="op">=</span>[<span class="st">&#39;customerId&#39;</span>,<span class="st">&#39;transactionAmount&#39;</span>,<span class="st">&#39;merchantName&#39;</span>]).<span class="bu">max</span>(<span class="st">&#39;transactionDateTime_x&#39;</span>)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="co">#finding the latest transactions correspond to the reversal transaction </span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="co">#Change selected to temporary data.</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>df3.at[df3.index.isin(df_maxtime.indexer_x),<span class="st">&quot;Rev_indicator&quot;</span>]<span class="op">=</span> <span class="st">&quot;YES&quot;</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="co">#apply index to df3</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>df3[df3[<span class="st">&#39;Rev_indicator&#39;</span>]<span class="op">==</span><span class="st">&quot;YES&quot;</span>]</span></code></pre></div>
<div class="output execute_result" data-execution_count="102">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>accountNumber</th>
      <th>customerId</th>
      <th>creditLimit</th>
      <th>availableMoney</th>
      <th>transactionDateTime</th>
      <th>transactionAmount</th>
      <th>merchantName</th>
      <th>acqCountry</th>
      <th>merchantCountryCode</th>
      <th>posEntryMode</th>
      <th>posConditionCode</th>
      <th>merchantCategoryCode</th>
      <th>currentExpDate</th>
      <th>accountOpenDate</th>
      <th>dateOfLastAddressChange</th>
      <th>cardCVV</th>
      <th>enteredCVV</th>
      <th>cardLast4Digits</th>
      <th>transactionType</th>
      <th>currentBalance</th>
      <th>cardPresent</th>
      <th>expirationDateKeyInMatch</th>
      <th>isFraud</th>
      <th>hour</th>
      <th>dayofweek</th>
      <th>month</th>
      <th>year</th>
      <th>indexer</th>
      <th>Rev_indicator</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>38</th>
      <td>574788567</td>
      <td>574788567</td>
      <td>2500.0</td>
      <td>2416.11</td>
      <td>2016-05-24T01:35:33</td>
      <td>215.13</td>
      <td>Convenient Tire</td>
      <td>US</td>
      <td>US</td>
      <td>09</td>
      <td>01</td>
      <td>auto</td>
      <td>10/2021</td>
      <td>2015-10-13</td>
      <td>2015-10-13</td>
      <td>206</td>
      <td>206</td>
      <td>8522</td>
      <td>PURCHASE</td>
      <td>83.89</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>1</td>
      <td>1</td>
      <td>5</td>
      <td>2016</td>
      <td>38</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>100</th>
      <td>924729945</td>
      <td>924729945</td>
      <td>50000.0</td>
      <td>50000.00</td>
      <td>2016-10-04T04:20:04</td>
      <td>168.57</td>
      <td>discount.com</td>
      <td>US</td>
      <td>US</td>
      <td>05</td>
      <td>01</td>
      <td>online_retail</td>
      <td>11/2024</td>
      <td>2014-07-25</td>
      <td>2014-07-25</td>
      <td>205</td>
      <td>265</td>
      <td>9459</td>
      <td>PURCHASE</td>
      <td>0.00</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>4</td>
      <td>1</td>
      <td>10</td>
      <td>2016</td>
      <td>100</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>113</th>
      <td>984504651</td>
      <td>984504651</td>
      <td>50000.0</td>
      <td>49138.85</td>
      <td>2016-01-06T04:08:06</td>
      <td>83.64</td>
      <td>1st Sandwitch Bar #801388</td>
      <td>US</td>
      <td>US</td>
      <td>09</td>
      <td>01</td>
      <td>food</td>
      <td>11/2025</td>
      <td>2015-07-27</td>
      <td>2015-07-27</td>
      <td>640</td>
      <td>640</td>
      <td>8332</td>
      <td>PURCHASE</td>
      <td>861.15</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>4</td>
      <td>2</td>
      <td>1</td>
      <td>2016</td>
      <td>113</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>132</th>
      <td>984504651</td>
      <td>984504651</td>
      <td>50000.0</td>
      <td>46818.15</td>
      <td>2016-01-16T09:52:30</td>
      <td>450.74</td>
      <td>Planet Fitness #849960</td>
      <td>US</td>
      <td>US</td>
      <td>05</td>
      <td>01</td>
      <td>health</td>
      <td>08/2028</td>
      <td>2015-07-27</td>
      <td>2015-07-27</td>
      <td>640</td>
      <td>640</td>
      <td>8332</td>
      <td>PURCHASE</td>
      <td>3181.85</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>9</td>
      <td>5</td>
      <td>1</td>
      <td>2016</td>
      <td>132</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>138</th>
      <td>984504651</td>
      <td>984504651</td>
      <td>50000.0</td>
      <td>46341.05</td>
      <td>2016-01-17T08:13:08</td>
      <td>81.73</td>
      <td>AMC #724446</td>
      <td>US</td>
      <td>US</td>
      <td>09</td>
      <td>01</td>
      <td>entertainment</td>
      <td>12/2031</td>
      <td>2015-07-27</td>
      <td>2015-07-27</td>
      <td>640</td>
      <td>640</td>
      <td>8332</td>
      <td>PURCHASE</td>
      <td>3658.95</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>8</td>
      <td>6</td>
      <td>1</td>
      <td>2016</td>
      <td>138</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>786013</th>
      <td>205026043</td>
      <td>205026043</td>
      <td>5000.0</td>
      <td>1627.52</td>
      <td>2016-09-18T06:07:17</td>
      <td>56.26</td>
      <td>Lyft</td>
      <td>US</td>
      <td>US</td>
      <td>05</td>
      <td>01</td>
      <td>rideshare</td>
      <td>07/2031</td>
      <td>2008-04-15</td>
      <td>2008-04-15</td>
      <td>359</td>
      <td>359</td>
      <td>258</td>
      <td>PURCHASE</td>
      <td>3372.48</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>6</td>
      <td>6</td>
      <td>9</td>
      <td>2016</td>
      <td>786013</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>786070</th>
      <td>288358186</td>
      <td>288358186</td>
      <td>7500.0</td>
      <td>7407.25</td>
      <td>2016-08-02T18:42:42</td>
      <td>20.66</td>
      <td>ebay.com</td>
      <td>US</td>
      <td>US</td>
      <td>09</td>
      <td>01</td>
      <td>online_retail</td>
      <td>09/2028</td>
      <td>2014-08-21</td>
      <td>2014-08-21</td>
      <td>355</td>
      <td>355</td>
      <td>1665</td>
      <td>PURCHASE</td>
      <td>92.75</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>18</td>
      <td>1</td>
      <td>8</td>
      <td>2016</td>
      <td>786070</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>786119</th>
      <td>638498773</td>
      <td>638498773</td>
      <td>10000.0</td>
      <td>10000.00</td>
      <td>2016-01-01T19:45:47</td>
      <td>201.79</td>
      <td>KFC #928167</td>
      <td>US</td>
      <td>US</td>
      <td>05</td>
      <td>01</td>
      <td>fastfood</td>
      <td>11/2032</td>
      <td>2014-11-17</td>
      <td>2014-11-17</td>
      <td>175</td>
      <td>175</td>
      <td>321</td>
      <td>PURCHASE</td>
      <td>0.00</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>19</td>
      <td>4</td>
      <td>1</td>
      <td>2016</td>
      <td>786119</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>786207</th>
      <td>638498773</td>
      <td>638498773</td>
      <td>10000.0</td>
      <td>1271.91</td>
      <td>2016-10-09T04:52:23</td>
      <td>86.14</td>
      <td>Dunkin' Donuts #396342</td>
      <td>US</td>
      <td>US</td>
      <td>05</td>
      <td>01</td>
      <td>fastfood</td>
      <td>03/2025</td>
      <td>2014-11-17</td>
      <td>2014-11-17</td>
      <td>387</td>
      <td>387</td>
      <td>4635</td>
      <td>PURCHASE</td>
      <td>8728.09</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>4</td>
      <td>6</td>
      <td>10</td>
      <td>2016</td>
      <td>786207</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>786300</th>
      <td>732852505</td>
      <td>732852505</td>
      <td>50000.0</td>
      <td>49882.78</td>
      <td>2016-06-16T10:32:11</td>
      <td>22.55</td>
      <td>Uber</td>
      <td>US</td>
      <td>US</td>
      <td>90</td>
      <td>01</td>
      <td>rideshare</td>
      <td>07/2027</td>
      <td>2012-08-23</td>
      <td>2012-08-23</td>
      <td>939</td>
      <td>939</td>
      <td>3388</td>
      <td>PURCHASE</td>
      <td>117.22</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>10</td>
      <td>3</td>
      <td>6</td>
      <td>2016</td>
      <td>786300</td>
      <td>YES</td>
    </tr>
  </tbody>
</table>
<p>17756 rows  29 columns</p>
</div>
</div>
</div>
<div class="cell code" data-execution_count="103">
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df3[df3[<span class="st">&#39;Rev_indicator&#39;</span>]<span class="op">==</span><span class="st">&quot;YES&quot;</span>].shape[<span class="dv">0</span>], df3[df3[<span class="st">&#39;Rev_indicator&#39;</span>]<span class="op">==</span><span class="st">&quot;YES&quot;</span>][<span class="st">&#39;transactionAmount&#39;</span>].<span class="bu">sum</span>())</span></code></pre></div>
<div class="output stream stdout">
<pre><code>17756 2666451.8
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>There are 17756 cases of reversed transaction and the total dollar
amount of reversed transaction is $2,666,451.8.</p>
</div>
<section id="multi-swipe-transaction" class="cell markdown">
<h3>Multi-swipe transaction</h3>
</section>
<div class="cell markdown">
<p>Here are codes to create an indicator column for multi-swipe
transactions. The logic is explained in comments inside the code. It is
uncertain that the multi-swipe transaction can happen in which size of a
time window. This time 10 minutes were selected arbitrarily.</p>
</div>
<div class="cell code" data-execution_count="104">
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Continuing from df3 made for reversed transaction</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>df3[<span class="st">&#39;Multi_indicator&#39;</span>]<span class="op">=</span><span class="st">&quot;NO&quot;</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>df3_m<span class="op">=</span>df3[(df3[<span class="st">&#39;transactionType&#39;</span>]<span class="op">==</span><span class="st">&#39;PURCHASE&#39;</span>)] </span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co"># subset for only purchase data</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>df3_m.loc[:,<span class="st">&#39;timewindow&#39;</span>]<span class="op">=</span>pd.to_datetime(df3_m[<span class="st">&#39;transactionDateTime&#39;</span>])</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>df3_m.loc[:,<span class="st">&#39;timewindow_lower&#39;</span>]<span class="op">=</span>pd.to_datetime(df3_m[<span class="st">&#39;transactionDateTime&#39;</span>])<span class="op">-</span>datetime.timedelta(minutes<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>df3_m.loc[:,<span class="st">&#39;timewindow_upper&#39;</span>]<span class="op">=</span>pd.to_datetime(df3_m[<span class="st">&#39;transactionDateTime&#39;</span>])<span class="op">+</span>datetime.timedelta(minutes<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="co">#Creating time 10 minute window for a transaction.</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>df3_m[<span class="st">&#39;Multi_all&#39;</span>]<span class="op">=</span>df3_m.duplicated([<span class="st">&quot;customerId&quot;</span>, <span class="st">&quot;transactionAmount&quot;</span>,<span class="st">&quot;merchantName&quot;</span>],keep<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Temporary indictor for transactions that has duplicated transactions in terms of id, smount and merchant </span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="co">#(does not mean they are multi swipe though)</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>df3_m[<span class="st">&#39;Multi_error&#39;</span>]<span class="op">=</span>df3_m.duplicated([<span class="st">&quot;customerId&quot;</span>, <span class="st">&quot;transactionAmount&quot;</span>,<span class="st">&quot;merchantName&quot;</span>],keep<span class="op">=</span><span class="st">&#39;first&#39;</span>)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="co">#Give false for first transaction first transaction is normal not multiswiped</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>df3_m_merged<span class="op">=</span>df3_m[df3_m[<span class="st">&#39;Multi_all&#39;</span>]<span class="op">==</span><span class="va">True</span>].merge(df3_m[(df3_m[<span class="st">&#39;Multi_all&#39;</span>]<span class="op">==</span><span class="va">True</span>) <span class="op">&amp;</span> (df3_m[<span class="st">&#39;Multi_error&#39;</span>]<span class="op">==</span><span class="va">False</span>)], </span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>                                                   how<span class="op">=</span><span class="st">&#39;left&#39;</span>, left_on<span class="op">=</span>[<span class="st">&quot;customerId&quot;</span>, <span class="st">&quot;transactionAmount&quot;</span>,<span class="st">&quot;merchantName&quot;</span>], </span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>                                                   right_on<span class="op">=</span>[<span class="st">&quot;customerId&quot;</span>, <span class="st">&quot;transactionAmount&quot;</span>,<span class="st">&quot;merchantName&quot;</span>])</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a><span class="co">#merge dat to df3_m with multi transaction data to get indexer from it.</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>df3_m_2<span class="op">=</span>df3_m_merged[((df3_m_merged[<span class="st">&#39;Multi_error_x&#39;</span>]<span class="op">==</span><span class="va">False</span>)<span class="op">|</span> (df3_m_merged[<span class="st">&#39;Multi_error_x&#39;</span>]<span class="op">==</span><span class="va">True</span>)</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> (df3_m_merged[<span class="st">&#39;timewindow_y&#39;</span>]<span class="op">&gt;</span>df3_m_merged[<span class="st">&#39;timewindow_lower_x&#39;</span>])  </span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>     <span class="op">&amp;</span> (df3_m_merged[<span class="st">&#39;timewindow_y&#39;</span>]<span class="op">&lt;</span>df3_m_merged[<span class="st">&#39;timewindow_upper_x&#39;</span>]))]</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a><span class="co">#add time filter makes out of window is not to be considered as a multi-swipe transaction</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>df3.at[df3.index.isin(df3_m_2[df3_m_2[<span class="st">&#39;Multi_error_x&#39;</span>]<span class="op">==</span><span class="va">True</span>][<span class="st">&#39;indexer_x&#39;</span>]),<span class="st">&quot;Multi_indicator&quot;</span>]<span class="op">=</span> <span class="st">&quot;YES&quot;</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a><span class="co">#applying the index to the df3</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>df3[df3[<span class="st">&#39;Multi_indicator&#39;</span>]<span class="op">==</span><span class="st">&quot;YES&quot;</span>]</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="output execute_result" data-execution_count="104">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>accountNumber</th>
      <th>customerId</th>
      <th>creditLimit</th>
      <th>availableMoney</th>
      <th>transactionDateTime</th>
      <th>transactionAmount</th>
      <th>merchantName</th>
      <th>acqCountry</th>
      <th>merchantCountryCode</th>
      <th>posEntryMode</th>
      <th>posConditionCode</th>
      <th>merchantCategoryCode</th>
      <th>currentExpDate</th>
      <th>accountOpenDate</th>
      <th>dateOfLastAddressChange</th>
      <th>cardCVV</th>
      <th>enteredCVV</th>
      <th>cardLast4Digits</th>
      <th>transactionType</th>
      <th>currentBalance</th>
      <th>cardPresent</th>
      <th>expirationDateKeyInMatch</th>
      <th>isFraud</th>
      <th>hour</th>
      <th>dayofweek</th>
      <th>month</th>
      <th>year</th>
      <th>indexer</th>
      <th>Rev_indicator</th>
      <th>Multi_indicator</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>263</th>
      <td>984504651</td>
      <td>984504651</td>
      <td>50000.0</td>
      <td>26680.99</td>
      <td>2016-03-12T06:34:29</td>
      <td>118.52</td>
      <td>AMC #706324</td>
      <td>US</td>
      <td>US</td>
      <td>02</td>
      <td>01</td>
      <td>entertainment</td>
      <td>10/2024</td>
      <td>2015-07-27</td>
      <td>2015-07-27</td>
      <td>640</td>
      <td>640</td>
      <td>8332</td>
      <td>PURCHASE</td>
      <td>23319.01</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>6</td>
      <td>5</td>
      <td>3</td>
      <td>2016</td>
      <td>263</td>
      <td>NO</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>264</th>
      <td>984504651</td>
      <td>984504651</td>
      <td>50000.0</td>
      <td>26562.47</td>
      <td>2016-03-12T06:36:41</td>
      <td>118.52</td>
      <td>AMC #706324</td>
      <td>US</td>
      <td>US</td>
      <td>02</td>
      <td>01</td>
      <td>entertainment</td>
      <td>10/2024</td>
      <td>2015-07-27</td>
      <td>2015-07-27</td>
      <td>640</td>
      <td>640</td>
      <td>8332</td>
      <td>PURCHASE</td>
      <td>23437.53</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>6</td>
      <td>5</td>
      <td>3</td>
      <td>2016</td>
      <td>264</td>
      <td>NO</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>281</th>
      <td>984504651</td>
      <td>984504651</td>
      <td>50000.0</td>
      <td>24316.12</td>
      <td>2016-03-18T13:57:04</td>
      <td>26.71</td>
      <td>Planet Fitness #692929</td>
      <td>US</td>
      <td>US</td>
      <td>02</td>
      <td>01</td>
      <td>health</td>
      <td>10/2024</td>
      <td>2015-07-27</td>
      <td>2015-07-27</td>
      <td>640</td>
      <td>640</td>
      <td>8332</td>
      <td>PURCHASE</td>
      <td>25683.88</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>13</td>
      <td>4</td>
      <td>3</td>
      <td>2016</td>
      <td>281</td>
      <td>NO</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>339</th>
      <td>984504651</td>
      <td>984504651</td>
      <td>50000.0</td>
      <td>16503.49</td>
      <td>2016-04-08T22:21:11</td>
      <td>43.21</td>
      <td>WSC #994275</td>
      <td>US</td>
      <td>US</td>
      <td>02</td>
      <td>08</td>
      <td>health</td>
      <td>02/2030</td>
      <td>2015-07-27</td>
      <td>2016-03-26</td>
      <td>640</td>
      <td>640</td>
      <td>8332</td>
      <td>PURCHASE</td>
      <td>33496.51</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>22</td>
      <td>4</td>
      <td>4</td>
      <td>2016</td>
      <td>339</td>
      <td>NO</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>413</th>
      <td>984504651</td>
      <td>984504651</td>
      <td>50000.0</td>
      <td>7302.32</td>
      <td>2016-05-07T07:32:54</td>
      <td>23.82</td>
      <td>Golds Gym #846582</td>
      <td>US</td>
      <td>US</td>
      <td>09</td>
      <td>01</td>
      <td>health</td>
      <td>12/2030</td>
      <td>2015-07-27</td>
      <td>2016-05-05</td>
      <td>640</td>
      <td>640</td>
      <td>8332</td>
      <td>PURCHASE</td>
      <td>42697.68</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>7</td>
      <td>5</td>
      <td>5</td>
      <td>2016</td>
      <td>413</td>
      <td>NO</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>785758</th>
      <td>207667444</td>
      <td>207667444</td>
      <td>7500.0</td>
      <td>6893.70</td>
      <td>2016-10-14T13:24:58</td>
      <td>79.82</td>
      <td>discount.com</td>
      <td>US</td>
      <td>US</td>
      <td>02</td>
      <td>01</td>
      <td>online_retail</td>
      <td>03/2025</td>
      <td>2011-12-12</td>
      <td>2016-08-16</td>
      <td>235</td>
      <td>235</td>
      <td>9853</td>
      <td>PURCHASE</td>
      <td>606.30</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>13</td>
      <td>4</td>
      <td>10</td>
      <td>2016</td>
      <td>785758</td>
      <td>NO</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>785915</th>
      <td>428856030</td>
      <td>428856030</td>
      <td>250.0</td>
      <td>104.44</td>
      <td>2016-10-30T20:59:18</td>
      <td>314.07</td>
      <td>Rodeway Inn #438868</td>
      <td>US</td>
      <td>US</td>
      <td>02</td>
      <td>01</td>
      <td>hotels</td>
      <td>02/2027</td>
      <td>2009-08-17</td>
      <td>2009-08-17</td>
      <td>990</td>
      <td>990</td>
      <td>7660</td>
      <td>PURCHASE</td>
      <td>145.56</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>20</td>
      <td>6</td>
      <td>10</td>
      <td>2016</td>
      <td>785915</td>
      <td>NO</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>785983</th>
      <td>205026043</td>
      <td>205026043</td>
      <td>5000.0</td>
      <td>451.59</td>
      <td>2016-06-07T22:29:11</td>
      <td>391.94</td>
      <td>Uber</td>
      <td>US</td>
      <td>US</td>
      <td>09</td>
      <td>08</td>
      <td>rideshare</td>
      <td>12/2029</td>
      <td>2008-04-15</td>
      <td>2008-04-15</td>
      <td>198</td>
      <td>198</td>
      <td>3931</td>
      <td>PURCHASE</td>
      <td>4548.41</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>22</td>
      <td>1</td>
      <td>6</td>
      <td>2016</td>
      <td>785983</td>
      <td>NO</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>785984</th>
      <td>205026043</td>
      <td>205026043</td>
      <td>5000.0</td>
      <td>433.52</td>
      <td>2016-06-07T22:30:57</td>
      <td>391.94</td>
      <td>Uber</td>
      <td>US</td>
      <td>US</td>
      <td>09</td>
      <td>08</td>
      <td>rideshare</td>
      <td>12/2029</td>
      <td>2008-04-15</td>
      <td>2008-04-15</td>
      <td>198</td>
      <td>198</td>
      <td>3931</td>
      <td>PURCHASE</td>
      <td>4566.48</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>22</td>
      <td>1</td>
      <td>6</td>
      <td>2016</td>
      <td>785984</td>
      <td>NO</td>
      <td>YES</td>
    </tr>
    <tr>
      <th>786233</th>
      <td>638498773</td>
      <td>638498773</td>
      <td>10000.0</td>
      <td>3049.18</td>
      <td>2016-11-29T23:12:01</td>
      <td>390.98</td>
      <td>Krispy Kreme #653472</td>
      <td>US</td>
      <td>US</td>
      <td>05</td>
      <td>01</td>
      <td>fastfood</td>
      <td>07/2032</td>
      <td>2014-11-17</td>
      <td>2014-11-17</td>
      <td>175</td>
      <td>175</td>
      <td>321</td>
      <td>PURCHASE</td>
      <td>6950.82</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>23</td>
      <td>1</td>
      <td>11</td>
      <td>2016</td>
      <td>786233</td>
      <td>NO</td>
      <td>YES</td>
    </tr>
  </tbody>
</table>
<p>7429 rows  30 columns</p>
</div>
</div>
</div>
<div class="cell code" data-execution_count="105">
<div class="sourceCode" id="cb42"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df3[df3[<span class="st">&#39;Multi_indicator&#39;</span>]<span class="op">==</span><span class="st">&quot;YES&quot;</span>].shape[<span class="dv">0</span>], df3[df3[<span class="st">&#39;Multi_indicator&#39;</span>]<span class="op">==</span><span class="st">&quot;YES&quot;</span>][<span class="st">&#39;transactionAmount&#39;</span>].<span class="bu">sum</span>())</span></code></pre></div>
<div class="output stream stdout">
<pre><code>7429 1102003.3299999998
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>There are 7429 cases of multi-swiped transaction and the total dollar
amount of reversed transaction is //$1,102,003.</p>
</div>
<div class="cell markdown">
<p>Here are some contingency tables for isFraud and the indicator just
created</p>
</div>
<div class="cell code" data-execution_count="106">
<div class="sourceCode" id="cb44"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>contingency<span class="op">=</span> pd.crosstab(df3[<span class="st">&quot;isFraud&quot;</span>], df3[<span class="st">&quot;Rev_indicator&quot;</span>]) <span class="co">#2x2 contigency table with count</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>contingency</span></code></pre></div>
<div class="output execute_result" data-execution_count="106">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Rev_indicator</th>
      <th>NO</th>
      <th>YES</th>
    </tr>
    <tr>
      <th>isFraud</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>False</th>
      <td>756493</td>
      <td>17453</td>
    </tr>
    <tr>
      <th>True</th>
      <td>12114</td>
      <td>303</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell code" data-execution_count="107">
<div class="sourceCode" id="cb45"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>contingency_pct <span class="op">=</span> pd.crosstab(df3[<span class="st">&quot;isFraud&quot;</span>], df3[<span class="st">&quot;Rev_indicator&quot;</span>], normalize<span class="op">=</span><span class="st">&#39;index&#39;</span>) <span class="co">#2x2 contigency table with pct</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>contingency_pct</span></code></pre></div>
<div class="output execute_result" data-execution_count="107">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Rev_indicator</th>
      <th>NO</th>
      <th>YES</th>
    </tr>
    <tr>
      <th>isFraud</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>False</th>
      <td>0.977449</td>
      <td>0.022551</td>
    </tr>
    <tr>
      <th>True</th>
      <td>0.975598</td>
      <td>0.024402</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell code" data-execution_count="108">
<div class="sourceCode" id="cb46"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>c, p, dof, expected <span class="op">=</span> chi2_contingency(contingency)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>p <span class="co"># Getting p-value for the chisquare test.</span></span></code></pre></div>
<div class="output execute_result" data-execution_count="108">
<pre><code>0.17791158543034952</code></pre>
</div>
</div>
<div class="cell markdown">
<p>Chi square test is used to test the independece of two categorical
features of interest. The proportional difference in fraud for reversed
transactions does not show a statistical difference.</p>
</div>
<div class="cell code" data-execution_count="109">
<div class="sourceCode" id="cb48"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>contingency<span class="op">=</span> pd.crosstab(df3[<span class="st">&quot;isFraud&quot;</span>], df3[<span class="st">&quot;Multi_indicator&quot;</span>]) <span class="co">#2x2 contigency table with count</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>contingency</span></code></pre></div>
<div class="output execute_result" data-execution_count="109">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Multi_indicator</th>
      <th>NO</th>
      <th>YES</th>
    </tr>
    <tr>
      <th>isFraud</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>False</th>
      <td>766645</td>
      <td>7301</td>
    </tr>
    <tr>
      <th>True</th>
      <td>12289</td>
      <td>128</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell code" data-execution_count="110">
<div class="sourceCode" id="cb49"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>contingency_pct <span class="op">=</span> pd.crosstab(df3[<span class="st">&quot;isFraud&quot;</span>], df3[<span class="st">&quot;Multi_indicator&quot;</span>], normalize<span class="op">=</span><span class="st">&#39;index&#39;</span>) <span class="co">#2x2 contigency table with pct</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>contingency_pct</span></code></pre></div>
<div class="output execute_result" data-execution_count="110">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Multi_indicator</th>
      <th>NO</th>
      <th>YES</th>
    </tr>
    <tr>
      <th>isFraud</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>False</th>
      <td>0.990567</td>
      <td>0.009433</td>
    </tr>
    <tr>
      <th>True</th>
      <td>0.989692</td>
      <td>0.010308</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell code" data-execution_count="111">
<div class="sourceCode" id="cb50"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>c, p, dof, expected <span class="op">=</span> chi2_contingency(contingency)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>p <span class="co"># Getting p-value for the chisquare test.</span></span></code></pre></div>
<div class="output execute_result" data-execution_count="111">
<pre><code>0.3405188183914446</code></pre>
</div>
</div>
<div class="cell markdown">
<p>The proportional difference in fraud for multi-swiped and non-swiped
transactions does not show a statistical difference.</p>
</div>
<section id="5-modeling" class="cell markdown">
<h2>5. Modeling</h2>
<h3
id="classficiation-modeling-for-detection-of-fraduelent-transaction">Classficiation
modeling for detection of fraduelent transaction</h3>
</section>
<div class="cell markdown">
<p>For this classification task, the most accessible model that can be
used is the logistic regression model. Therefore, I will set the
logistic regression model as a baseline model. The logistic regression
model, specifically, a logistic regression model with l1 penalty
(Lasso), will be used. The L1 penalty penalizes the predictors with weak
predictive values and automatically penalizes and does not play in the
model.</p>
<p>The other approach is selected for one of the tree-based models. The
model I am going to suggest is XGBoost. Maybe the most well-known
tree-based model is Random Forest. The naive comparison of Random forest
and XGBoost is that Random Forest decides the final model with a
champion among different tree models. On the other hand, XGBoost refines
from weaker tree to stronger tree. I decided to use XGboost over Random
forest because Xgboost works better for imbalanced classification tasks
than random forest if I can avoid the possible overfitting in XGboost.
Also, previous work experience told me that XGBoost is pretty reliable
in classification and feature selection.</p>
<p>In addition to comparing logistic regression and Xgboost, I will
compare the feature engineering that I have done during Q1~Q3 and some
additional feature engineering. So first, I will just run with the
original data I have with minimal preprocessing of data with just a
dummy coding for categorical variables. Next, I will add additional
predictors and run the same analysis for logistic regression and XG
boost.</p>
</div>
<div class="cell code" data-execution_count="246">
<div class="sourceCode" id="cb52"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy <span class="im">import</span> loadtxt</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xgboost</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xgboost <span class="im">import</span> XGBClassifier</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> RepeatedStratifiedKFold</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> make_classification</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy <span class="im">import</span> where</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy <span class="im">import</span> mean</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> make_classification</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_score</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_predict</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> RepeatedStratifiedKFold</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xgboost <span class="im">import</span> XGBClassifier</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> StratifiedKFold</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> imblearn.over_sampling <span class="im">import</span> SMOTE</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a><span class="co">#from imblearn.over_sampling import SMOTE</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xgboost <span class="im">import</span> Booster</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xgboost <span class="im">import</span> DMatrix</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> metrics</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="247">
<div class="sourceCode" id="cb53"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>df4<span class="op">=</span>df3.copy() <span class="co">#df4 will be used for logistic regression and xgboost for minimal preprocessing of data.</span></span></code></pre></div>
</div>
<div class="cell code" data-execution_count="248">
<div class="sourceCode" id="cb54"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>tempdf<span class="op">=</span>pd.get_dummies(df4.merchantCategoryCode, prefix<span class="op">=</span><span class="st">&#39;merchantCategoryCode&#39;</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>df4<span class="op">=</span>pd.concat([df4, tempdf], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>tempdf<span class="op">=</span>pd.get_dummies(df4.transactionType, prefix<span class="op">=</span><span class="st">&#39;transactionType&#39;</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>df4<span class="op">=</span>pd.concat([df4, tempdf], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>tempdf<span class="op">=</span>pd.get_dummies(df4.posEntryMode, prefix<span class="op">=</span><span class="st">&#39;posEntryMode&#39;</span>)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>df4<span class="op">=</span>pd.concat([df4, tempdf], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>tempdf<span class="op">=</span>pd.get_dummies(df4.acqCountry, prefix<span class="op">=</span><span class="st">&#39;acqCountry&#39;</span>)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>df4<span class="op">=</span>pd.concat([df4, tempdf], axis<span class="op">=</span><span class="dv">1</span>)   </span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="co">#Dummy coding for the categorical variable to be used</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>df4[<span class="st">&quot;isFraud&quot;</span>]<span class="op">=</span>df4[<span class="st">&quot;isFraud&quot;</span>]<span class="op">*</span><span class="dv">1</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>df4[<span class="st">&#39;cardPresent&#39;</span>]<span class="op">=</span>df4[<span class="st">&#39;cardPresent&#39;</span>]<span class="op">*</span><span class="dv">1</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="co">#just in case for error made it to numeric</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>df_train, df_test<span class="op">=</span>train_test_split(df4,test_size<span class="op">=</span><span class="fl">0.3</span>,random_state<span class="op">=</span><span class="dv">8</span>,stratify<span class="op">=</span>df4[[<span class="st">&#39;isFraud&#39;</span>]])</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Stratified sampling of 70% training 30% test</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>train_counts<span class="op">=</span>df_train[<span class="st">&#39;isFraud&#39;</span>]</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">sum</span>(df_train[<span class="st">&#39;isFraud&#39;</span>])<span class="op">/</span>df_train.shape[<span class="dv">0</span>])</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">sum</span>(df_test[<span class="st">&#39;isFraud&#39;</span>])<span class="op">/</span>df_test.shape[<span class="dv">0</span>])</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">sum</span>(df4[<span class="st">&#39;isFraud&#39;</span>])<span class="op">/</span>df4.shape[<span class="dv">0</span>])</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a><span class="co">#To check the sratified sampling worked correctly</span></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>drops<span class="op">=</span>[<span class="st">&#39;accountNumber&#39;</span>,</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;customerId&#39;</span>,</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;transactionDateTime&#39;</span>,</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;merchantName&#39;</span>,</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;acqCountry&#39;</span>,</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;merchantCountryCode&#39;</span>,</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;posEntryMode&#39;</span>,</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;posConditionCode&#39;</span>,</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;merchantCategoryCode&#39;</span>,</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;currentExpDate&#39;</span>,</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;accountOpenDate&#39;</span>,</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;dateOfLastAddressChange&#39;</span>,</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;cardCVV&#39;</span>,</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;enteredCVV&#39;</span>,</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;cardLast4Digits&#39;</span>,</span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;transactionType&#39;</span>,</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;currentBalance&#39;</span>,</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;expirationDateKeyInMatch&#39;</span>,</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>       <span class="st">&#39;Rev_indicator&#39;</span>,</span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>       <span class="st">&#39;Multi_indicator&#39;</span>,</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;hour&#39;</span>,</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>       <span class="st">&#39;dayofweek&#39;</span>,</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>       <span class="st">&#39;month&#39;</span>,</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>       <span class="st">&#39;year&#39;</span>,</span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>       <span class="st">&#39;indexer&#39;</span>]</span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a><span class="co">#List of features to be dropped.</span></span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a>X_trainall <span class="op">=</span> df_train.iloc[:, df_train.columns <span class="op">!=</span> <span class="st">&#39;isFraud&#39;</span>]</span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>X_train<span class="op">=</span>X_trainall.drop(drops, axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> df_train.iloc[:, df_train.columns <span class="op">==</span> <span class="st">&#39;isFraud&#39;</span>]</span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a>X_testall <span class="op">=</span> df_test.iloc[:, df_test.columns <span class="op">!=</span> <span class="st">&#39;isFraud&#39;</span>]</span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a>X_test<span class="op">=</span>X_testall.drop(drops, axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> df_test.iloc[:, df_test.columns <span class="op">==</span> <span class="st">&#39;isFraud&#39;</span>]</span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a><span class="co">#Spliting train and test for X and y with dropping feautres not used for the modeling.</span></span></code></pre></div>
<div class="output stream stdout">
<pre><code>0.01579060193948995

0.015789986816950603

0.01579041740264992
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>The categorical variables are dummy coded. The training set and the
test were sampled, and they will be used for both logistic regression
and XGboost.</p>
</div>
<div class="cell code">
<div class="sourceCode" id="cb56"><pre
class="sourceCode python"><code class="sourceCode python"></code></pre></div>
</div>
<div class="cell code" data-execution_count="249">
<div class="sourceCode" id="cb57"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># roc curve and auc</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> make_classification</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_curve</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_auc_score</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>model_logistic <span class="op">=</span> LogisticRegression(penalty<span class="op">=</span><span class="st">&#39;l1&#39;</span>,solver<span class="op">=</span><span class="st">&#39;liblinear&#39;</span>)</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>model_logistic.fit(X_train, y_train)</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>model_logistic.score(X_test,y_test) </span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="co">#running logistic regression with L1 penalty</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="co"># predict probabilities</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>lr_probs <span class="op">=</span> model_logistic.predict_proba(X_test)</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a><span class="co"># keep probabilities for the positive outcome only</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>lr_probs <span class="op">=</span> lr_probs[:, <span class="dv">1</span>]</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate scores</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>ns_probs <span class="op">=</span> [<span class="dv">0</span> <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(y_test))]</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>ns_auc <span class="op">=</span> roc_auc_score(y_test, ns_probs)</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>lr_auc <span class="op">=</span> roc_auc_score(y_test, lr_probs)</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize scores</span></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;No Skill: ROC AUC=</span><span class="sc">%.3f</span><span class="st">&#39;</span> <span class="op">%</span> (ns_auc))</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Logistic: ROC AUC=</span><span class="sc">%.3f</span><span class="st">&#39;</span> <span class="op">%</span> (lr_auc))</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate roc curves</span></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>ns_fpr, ns_tpr, _ <span class="op">=</span> roc_curve(y_test, ns_probs)</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>lr_fpr, lr_tpr, _ <span class="op">=</span> roc_curve(y_test, lr_probs)</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the roc curve for the model</span></span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>pyplot.plot(ns_fpr, ns_tpr, linestyle<span class="op">=</span><span class="st">&#39;--&#39;</span>, label<span class="op">=</span><span class="st">&#39;No Skill&#39;</span>)</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>pyplot.plot(lr_fpr, lr_tpr, marker<span class="op">=</span><span class="st">&#39;.&#39;</span>, label<span class="op">=</span><span class="st">&#39;Logistic&#39;</span>)</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a><span class="co"># axis labels</span></span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>pyplot.xlabel(<span class="st">&#39;False Positive Rate&#39;</span>)</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>pyplot.ylabel(<span class="st">&#39;True Positive Rate&#39;</span>)</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a><span class="co"># show the legend</span></span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>pyplot.legend()</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a><span class="co"># show the plot</span></span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>pyplot.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>No Skill: ROC AUC=0.500

Logistic: ROC AUC=0.749
</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_8a8eb62ffdfe4e549465fa0e38037da9/8bcf19d9dd13a0dfa3edf658c4943ecff25ee766.png" /></p>
</div>
</div>
<div class="cell markdown">
<p>Logistic lasso regression showed AUC of 0.749.</p>
</div>
<div class="cell code" data-execution_count="250">
<div class="sourceCode" id="cb59"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>model_default <span class="op">=</span> XGBClassifier(base_score<span class="op">=</span><span class="bu">sum</span>(df4[<span class="st">&#39;isFraud&#39;</span>])<span class="op">/</span>df4.shape[<span class="dv">0</span>])</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="co">#XG BOOST with base_score using portion of fraud</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>model_default.fit(X_train, y_train)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>y_pred_d <span class="op">=</span> model_default.predict_proba(X_test)[:,<span class="dv">1</span>]</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Prediction of y_test</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="co">###process to generate ROC curve</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>fp_r, tp_r, t <span class="op">=</span> metrics.roc_curve(y_test, y_pred_d)</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>auc <span class="op">=</span> metrics.auc(fp_r, tp_r)</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>plt.plot(fp_r, tp_r, label<span class="op">=</span><span class="st">&quot;AUC = </span><span class="sc">%.3f</span><span class="st">&quot;</span> <span class="op">%</span> auc)</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>,<span class="dv">1</span>],[<span class="dv">0</span>,<span class="dv">1</span>],<span class="st">&quot;r--&quot;</span>)</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;TP rate&quot;</span>)</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;FP rate&quot;</span>)</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;ROC Curve&quot;</span>)</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a><span class="co">###</span></span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_8a8eb62ffdfe4e549465fa0e38037da9/94674aa51bb45e3dff6d4c85004a38f5b05cf66d.png" /></p>
</div>
</div>
<div class="cell code" data-execution_count="251">
<div class="sourceCode" id="cb60"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>t_opt_idx <span class="op">=</span> np.argmax(tp_r <span class="op">-</span> fp_r)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>t_opt <span class="op">=</span> t[t_opt_idx]</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Threshold value is: </span><span class="sc">%.4f</span><span class="st">&quot;</span> <span class="op">%</span> t_opt)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Threshold value is: 0.0155
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>The treshold value that maximize true positive rate - false positive
rate is 0.0135. Let see how model behaves with other thresholds.</p>
</div>
<div class="cell code" data-execution_count="252">
<div class="sourceCode" id="cb62"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Confusion matrix using different treshold</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model_default.predict_proba(X_test)[:,<span class="dv">1</span>]</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">3</span>,<span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axes.flat):</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    threshold <span class="op">=</span> <span class="bu">round</span>((t<span class="op">+</span><span class="dv">1</span>)<span class="op">/</span><span class="dv">500</span>,<span class="dv">4</span>)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    y_pred_int <span class="op">=</span> (y_pred <span class="op">&gt;</span> threshold).astype(<span class="bu">int</span>)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    c_matrix <span class="op">=</span> metrics.confusion_matrix(y_test, y_pred_int)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(c_matrix, annot<span class="op">=</span><span class="va">True</span>, cmap<span class="op">=</span><span class="st">&quot;Blues&quot;</span>, fmt<span class="op">=</span><span class="st">&quot;d&quot;</span>, ax<span class="op">=</span>ax, cbar<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    ax.title.set_text(<span class="st">&quot;T=</span><span class="sc">%.4f</span><span class="st">&quot;</span> <span class="op">%</span> threshold)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(hspace<span class="op">=</span><span class="fl">0.5</span>, wspace<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">&quot;Impact of threshold adjustment on the error matrix&quot;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="252">
<pre><code>Text(0.5, 0.98, &#39;Impact of threshold adjustment on the error matrix&#39;)</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_8a8eb62ffdfe4e549465fa0e38037da9/d0547db6e2d524d5a8954bcf52aff6df859f2426.png" /></p>
</div>
</div>
<div class="cell markdown">
<p>Based on the purpose of the detection, one may choose a more
aggressive (lower threshold) prediction or a more conservative (higher
threshold) prediction.</p>
</div>
<div class="cell code" data-execution_count="253">
<div class="sourceCode" id="cb64"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>xgboost.plot_importance(model_default,  height<span class="op">=</span><span class="fl">0.5</span>, max_num_features<span class="op">=</span><span class="dv">20</span>, importance_type<span class="op">=</span><span class="st">&#39;gain&#39;</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_8a8eb62ffdfe4e549465fa0e38037da9/d705c6bc227171ed7162d0151f01e453dd234a98.png" /></p>
</div>
</div>
<div class="cell markdown">
<p>These are important features that contribute to the prediction. The
top two are cardPresent and poeEntryMode_05. I googled 'pos entry mode',
and the 05 means 'Integrated circuit reader'. Using a chip physically
also means the presence of a card, so they should be highly correlated
features.</p>
</div>
<div class="cell code" data-execution_count="260">
<div class="sourceCode" id="cb65"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>df5<span class="op">=</span>df3.copy()</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="261">
<div class="sourceCode" id="cb66"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>df5[<span class="st">&#39;TA_zscore&#39;</span>]<span class="op">=</span>(df5[<span class="st">&#39;transactionAmount&#39;</span>] <span class="op">-</span> df5[<span class="st">&#39;transactionAmount&#39;</span>].mean()) <span class="op">/</span> df5[<span class="st">&#39;transactionAmount&#39;</span>].std()</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Zscore for transaction amount</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>df5[<span class="st">&#39;TA_ZS_GRP&#39;</span>]<span class="op">=</span>df5.groupby(<span class="st">&#39;merchantCategoryCode&#39;</span>)[<span class="st">&#39;transactionAmount&#39;</span>].transform(<span class="kw">lambda</span> x: (x<span class="op">-</span>x.mean())<span class="op">/</span>x.std())</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Zscore grouped by &#39;merchantCategoryCode&#39;</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>df5[<span class="st">&#39;TA_ZS_POS&#39;</span>]<span class="op">=</span>df5.groupby(<span class="st">&#39;posEntryMode&#39;</span>)[<span class="st">&#39;transactionAmount&#39;</span>].transform(<span class="kw">lambda</span> x: (x<span class="op">-</span>x.mean())<span class="op">/</span>x.std())</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Zscore grouped by &#39;posEntryMode&#39;</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>df5[<span class="st">&#39;TA_ZS_hold&#39;</span>]<span class="op">=</span>df5.groupby(<span class="st">&#39;cardPresent&#39;</span>)[<span class="st">&#39;transactionAmount&#39;</span>].transform(<span class="kw">lambda</span> x: (x<span class="op">-</span>x.mean())<span class="op">/</span>x.std())</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="co">#Zscore grouped by &#39;cardPresent&#39;</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="co">#### Dummy coding </span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>tempdf<span class="op">=</span>pd.get_dummies(df5.merchantCategoryCode, prefix<span class="op">=</span><span class="st">&#39;merchantCategoryCode&#39;</span>)</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>df5<span class="op">=</span>pd.concat([df5, tempdf], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>tempdf<span class="op">=</span>pd.get_dummies(df5.transactionType, prefix<span class="op">=</span><span class="st">&#39;transactionType&#39;</span>)</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>df5<span class="op">=</span>pd.concat([df5, tempdf], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>tempdf<span class="op">=</span>pd.get_dummies(df5.posEntryMode, prefix<span class="op">=</span><span class="st">&#39;posEntryMode&#39;</span>)</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>df5<span class="op">=</span>pd.concat([df5, tempdf], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>tempdf<span class="op">=</span>pd.get_dummies(df5.acqCountry, prefix<span class="op">=</span><span class="st">&#39;acqCountry&#39;</span>)</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>df5<span class="op">=</span>pd.concat([df5, tempdf], axis<span class="op">=</span><span class="dv">1</span>)   </span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>tempdf<span class="op">=</span>pd.get_dummies(df5.acqCountry, prefix<span class="op">=</span><span class="st">&#39;hour&#39;</span>)</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>df5<span class="op">=</span>pd.concat([df5, tempdf], axis<span class="op">=</span><span class="dv">1</span>)  </span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>tempdf<span class="op">=</span>pd.get_dummies(df5.acqCountry, prefix<span class="op">=</span><span class="st">&#39;month&#39;</span>)</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>df5<span class="op">=</span>pd.concat([df5, tempdf], axis<span class="op">=</span><span class="dv">1</span>)  </span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>tempdf<span class="op">=</span>pd.get_dummies(df5.acqCountry, prefix<span class="op">=</span><span class="st">&#39;dayofweek&#39;</span>)</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>df5<span class="op">=</span>pd.concat([df5, tempdf], axis<span class="op">=</span><span class="dv">1</span>)  </span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>tempdf<span class="op">=</span>pd.get_dummies(df5.acqCountry, prefix<span class="op">=</span><span class="st">&#39;Rev_indicator&#39;</span>)</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>df5<span class="op">=</span>pd.concat([df5, tempdf], axis<span class="op">=</span><span class="dv">1</span>)  </span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>tempdf<span class="op">=</span>pd.get_dummies(df5.acqCountry, prefix<span class="op">=</span><span class="st">&#39;Multi_indicator&#39;</span>)</span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>df5<span class="op">=</span>pd.concat([df5, tempdf], axis<span class="op">=</span><span class="dv">1</span>) </span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a><span class="co">#### Dummy coding </span></span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>df5[<span class="st">&quot;isFraud&quot;</span>]<span class="op">=</span>df5[<span class="st">&quot;isFraud&quot;</span>]<span class="op">*</span><span class="dv">1</span></span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>df5[<span class="st">&#39;cardPresent&#39;</span>]<span class="op">=</span>df5[<span class="st">&#39;cardPresent&#39;</span>]<span class="op">*</span><span class="dv">1</span></span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a><span class="co">#making into nuemric to avoide possible error</span></span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>df_train, df_test<span class="op">=</span>train_test_split(df5,test_size<span class="op">=</span><span class="fl">0.3</span>,random_state<span class="op">=</span><span class="dv">8</span>,stratify<span class="op">=</span>df5[[<span class="st">&#39;isFraud&#39;</span>]])</span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Stratified sampling of 70% training 30% test</span></span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>train_counts<span class="op">=</span>df_train[<span class="st">&#39;isFraud&#39;</span>]</span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">sum</span>(df_train[<span class="st">&#39;isFraud&#39;</span>])<span class="op">/</span>df_train.shape[<span class="dv">0</span>])</span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">sum</span>(df_test[<span class="st">&#39;isFraud&#39;</span>])<span class="op">/</span>df_test.shape[<span class="dv">0</span>])</span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">sum</span>(df5[<span class="st">&#39;isFraud&#39;</span>])<span class="op">/</span>df5.shape[<span class="dv">0</span>])</span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a><span class="co">#checking for correct stratified sampling</span></span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a>drops<span class="op">=</span>[<span class="st">&#39;accountNumber&#39;</span>,</span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;customerId&#39;</span>,</span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;transactionDateTime&#39;</span>,</span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;merchantName&#39;</span>,</span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;acqCountry&#39;</span>,</span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;merchantCountryCode&#39;</span>,</span>
<span id="cb66-49"><a href="#cb66-49" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;posEntryMode&#39;</span>,</span>
<span id="cb66-50"><a href="#cb66-50" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;posConditionCode&#39;</span>,</span>
<span id="cb66-51"><a href="#cb66-51" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;merchantCategoryCode&#39;</span>,</span>
<span id="cb66-52"><a href="#cb66-52" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;currentExpDate&#39;</span>,</span>
<span id="cb66-53"><a href="#cb66-53" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;accountOpenDate&#39;</span>,</span>
<span id="cb66-54"><a href="#cb66-54" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;dateOfLastAddressChange&#39;</span>,</span>
<span id="cb66-55"><a href="#cb66-55" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;cardCVV&#39;</span>,</span>
<span id="cb66-56"><a href="#cb66-56" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;enteredCVV&#39;</span>,</span>
<span id="cb66-57"><a href="#cb66-57" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;cardLast4Digits&#39;</span>,</span>
<span id="cb66-58"><a href="#cb66-58" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;transactionType&#39;</span>,</span>
<span id="cb66-59"><a href="#cb66-59" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;currentBalance&#39;</span>,</span>
<span id="cb66-60"><a href="#cb66-60" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;expirationDateKeyInMatch&#39;</span>,</span>
<span id="cb66-61"><a href="#cb66-61" aria-hidden="true" tabindex="-1"></a>       <span class="st">&#39;indexer&#39;</span>,<span class="st">&#39;Rev_indicator&#39;</span>,<span class="st">&#39;Multi_indicator&#39;</span>]</span>
<span id="cb66-62"><a href="#cb66-62" aria-hidden="true" tabindex="-1"></a>X_trainall <span class="op">=</span> df_train.iloc[:, df_train.columns <span class="op">!=</span> <span class="st">&#39;isFraud&#39;</span>]</span>
<span id="cb66-63"><a href="#cb66-63" aria-hidden="true" tabindex="-1"></a>X_train<span class="op">=</span>X_trainall.drop(drops, axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb66-64"><a href="#cb66-64" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> df_train.iloc[:, df_train.columns <span class="op">==</span> <span class="st">&#39;isFraud&#39;</span>]</span>
<span id="cb66-65"><a href="#cb66-65" aria-hidden="true" tabindex="-1"></a>X_testall <span class="op">=</span> df_test.iloc[:, df_test.columns <span class="op">!=</span> <span class="st">&#39;isFraud&#39;</span>]</span>
<span id="cb66-66"><a href="#cb66-66" aria-hidden="true" tabindex="-1"></a>X_test<span class="op">=</span>X_testall.drop(drops, axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb66-67"><a href="#cb66-67" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> df_test.iloc[:, df_test.columns <span class="op">==</span> <span class="st">&#39;isFraud&#39;</span>]</span>
<span id="cb66-68"><a href="#cb66-68" aria-hidden="true" tabindex="-1"></a><span class="co">#Spliting train and test for X and y with dropping feautres not used for the modeling.</span></span></code></pre></div>
<div class="output stream stdout">
<pre><code>0.01579060193948995

0.015789986816950603

0.01579041740264992
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="262">
<div class="sourceCode" id="cb68"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># roc curve and auc</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> make_classification</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_curve</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_auc_score</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>model_logistic <span class="op">=</span> LogisticRegression(penalty<span class="op">=</span><span class="st">&#39;l1&#39;</span>,solver<span class="op">=</span><span class="st">&#39;liblinear&#39;</span>)</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>model_logistic.fit(X_train, y_train)</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>model_logistic.score(X_test,y_test) </span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="co">#running logistic regression with L1 penalty</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="co"># predict probabilities</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>lr_probs <span class="op">=</span> model_logistic.predict_proba(X_test)</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a><span class="co"># keep probabilities for the positive outcome only</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>lr_probs <span class="op">=</span> lr_probs[:, <span class="dv">1</span>]</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate scores</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>ns_probs <span class="op">=</span> [<span class="dv">0</span> <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(y_test))]</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>ns_auc <span class="op">=</span> roc_auc_score(y_test, ns_probs)</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>lr_auc <span class="op">=</span> roc_auc_score(y_test, lr_probs)</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize scores</span></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;No Skill: ROC AUC=</span><span class="sc">%.3f</span><span class="st">&#39;</span> <span class="op">%</span> (ns_auc))</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Logistic: ROC AUC=</span><span class="sc">%.3f</span><span class="st">&#39;</span> <span class="op">%</span> (lr_auc))</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate roc curves</span></span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>ns_fpr, ns_tpr, _ <span class="op">=</span> roc_curve(y_test, ns_probs)</span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>lr_fpr, lr_tpr, _ <span class="op">=</span> roc_curve(y_test, lr_probs)</span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the roc curve for the model</span></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>pyplot.plot(ns_fpr, ns_tpr, linestyle<span class="op">=</span><span class="st">&#39;--&#39;</span>, label<span class="op">=</span><span class="st">&#39;No Skill&#39;</span>)</span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>pyplot.plot(lr_fpr, lr_tpr, marker<span class="op">=</span><span class="st">&#39;.&#39;</span>, label<span class="op">=</span><span class="st">&#39;Logistic&#39;</span>)</span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a><span class="co"># axis labels</span></span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>pyplot.xlabel(<span class="st">&#39;False Positive Rate&#39;</span>)</span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a>pyplot.ylabel(<span class="st">&#39;True Positive Rate&#39;</span>)</span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a><span class="co"># show the legend</span></span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a>pyplot.legend()</span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a><span class="co"># show the plot</span></span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a>pyplot.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>No Skill: ROC AUC=0.500

Logistic: ROC AUC=0.749
</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_8a8eb62ffdfe4e549465fa0e38037da9/fadbfcd9e02cfff467703befa10bc945ff42407d.png" /></p>
</div>
</div>
<div class="cell markdown">
<p>Zero improvement from previous model with additional features.</p>
</div>
<div class="cell code" data-execution_count="263">
<div class="sourceCode" id="cb70"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>model_default <span class="op">=</span> XGBClassifier(base_score<span class="op">=</span><span class="bu">sum</span>(df5[<span class="st">&#39;isFraud&#39;</span>])<span class="op">/</span>df5.shape[<span class="dv">0</span>])</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="co">#XG BOOST with base_score using portion of fraud</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>model_default.fit(X_train, y_train)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>y_pred_d <span class="op">=</span> model_default.predict_proba(X_test)[:,<span class="dv">1</span>]</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Prediction of y_test</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="co">###process to generate ROC curve</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>fp_r, tp_r, t <span class="op">=</span> metrics.roc_curve(y_test, y_pred_d)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>auc <span class="op">=</span> metrics.auc(fp_r, tp_r)</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>plt.plot(fp_r, tp_r, label<span class="op">=</span><span class="st">&quot;AUC = </span><span class="sc">%.3f</span><span class="st">&quot;</span> <span class="op">%</span> auc)</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>,<span class="dv">1</span>],[<span class="dv">0</span>,<span class="dv">1</span>],<span class="st">&quot;r--&quot;</span>)</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;TP rate&quot;</span>)</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;FP rate&quot;</span>)</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;ROC Curve&quot;</span>)</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a><span class="co">###</span></span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_8a8eb62ffdfe4e549465fa0e38037da9/3c22499ffaa8d425a223606df83f6b777b5fc9e3.png" /></p>
</div>
</div>
<div class="cell markdown">
<p>AUC even decreased slightly from previous XGBoost model (.782 to
.776).</p>
</div>
<section id="result" class="cell markdown">
<h3>Result</h3>
</section>
<div class="cell markdown">
<p>XGBoost shows better prediction than the logistic regression. But,
the additional features do not provide any benefit for either of the
modeling frameworks.</p>
</div>
<section id="future-work" class="cell markdown">
<h3>Future work</h3>
</section>
<div class="cell markdown">
<p>First, maybe I can do more works on the modeling frameworks side.
Even within XGBoost, I can try to look for better parameter tuning. I
tried for SMOTE (Synthetic Minority Oversampling Technique), but it did
not work well. I added the work related to the SMOTE at the end of this
document.</p>
<p>Second, and which is more important than the modeling framework, is
feature engineering. It can bring more impact with an increase in
predictive performance. One idea that I could not apply was using
previous Fraud records as a predictor. One problem that holds me back is
that I don't know the timing of the Fraud indicator update for the
transactions. At the timing of one transaction, I am unsure how to set a
lag for past fraud data. These kinds of predictors were used in my past
projects. There were features like "days_since_last_'target'",
"number_of_'target'_happened_during_months' and etc. If I had a better
background with this data and had more time, I could generate those
features and test them in the model.</p>
</div>
<section id="appendix-smote" class="cell markdown">
<h2>Appendix: SMOTE</h2>
</section>
<div class="cell markdown">
<p>The idea of SMOTE is to oversample the target label with fewer counts
(in our case isFraud==True) until the sample of each label becomes
50/50. It makes the imbalanced classification task into a balanced
classification task. Contrary to expectations, the SMOTE could not
improve the model. I will just add code for SMOTE as an appendix.</p>
</div>
<div class="cell code" data-execution_count="267">
<div class="sourceCode" id="cb71"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>X_train_smote, y_train_smote <span class="op">=</span> SMOTE(random_state<span class="op">=</span><span class="dv">10</span>).fit_resample(X_train, y_train)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>smote_value_counts <span class="op">=</span> y_train_smote[<span class="st">&#39;isFraud&#39;</span>].value_counts()</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Fraudulent transactions are </span><span class="sc">%.2f%%</span><span class="st"> of the test set.&quot;</span> <span class="op">%</span> (smote_value_counts[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span> <span class="op">/</span> <span class="bu">len</span>(y_train_smote)))</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Fraudulent transactions are 50.00% of the test set.
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="268">
<div class="sourceCode" id="cb73"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> xgboost_search(X, y, search_verbose<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> {</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;gamma&quot;</span>:[<span class="fl">0.5</span>, <span class="dv">1</span>, <span class="fl">1.5</span>, <span class="dv">2</span>, <span class="dv">5</span>],</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;max_depth&quot;</span>:[<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>],</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;min_child_weight&quot;</span>: [<span class="dv">100</span>],</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;subsample&quot;</span>: [<span class="fl">0.6</span>, <span class="fl">0.8</span>, <span class="fl">1.0</span>],</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;colsample_bytree&quot;</span>: [<span class="fl">0.6</span>, <span class="fl">0.8</span>, <span class="fl">1.0</span>],</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;learning_rate&quot;</span>: [<span class="fl">0.1</span>, <span class="fl">0.01</span>, <span class="fl">0.001</span>]</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>    xgb <span class="op">=</span> XGBClassifier(objective<span class="op">=</span><span class="st">&quot;binary:logistic&quot;</span>, eval_metric<span class="op">=</span><span class="st">&quot;auc&quot;</span>, use_label_encoder<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>    skf <span class="op">=</span> StratifiedKFold(n_splits<span class="op">=</span><span class="dv">3</span>, shuffle<span class="op">=</span><span class="va">True</span>, random_state<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>    grid_search <span class="op">=</span> GridSearchCV(estimator<span class="op">=</span>xgb, param_grid<span class="op">=</span>params, scoring<span class="op">=</span><span class="st">&quot;roc_auc&quot;</span>, n_jobs<span class="op">=</span><span class="dv">1</span>, cv<span class="op">=</span>skf.split(X,y), verbose<span class="op">=</span>search_verbose)</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>    grid_search.fit(X, y)</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Best estimator: &quot;</span>)</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(grid_search.best_estimator_)</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Parameters: &quot;</span>, grid_search.best_params_)</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Highest AUC: </span><span class="sc">%.2f</span><span class="st">&quot;</span> <span class="op">%</span> grid_search.best_score_)</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> grid_search.best_params_</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a><span class="co">#rows = random.sample(np.arange(0,len(X_train_smote.index)).tolist(), 5000)</span></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a><span class="co">#model_params = xgboost_search(X_train_smote.iloc[rows,], y_train_smote.iloc[rows,] )</span></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a><span class="co">#searched params are applied in next line. The running time is too long.</span></span></code></pre></div>
</div>
<div class="cell code" data-execution_count="270">
<div class="sourceCode" id="cb74"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> XGBClassifier(objective<span class="op">=</span><span class="st">&quot;binary:logistic&quot;</span>, eval_metric<span class="op">=</span><span class="st">&quot;auc&quot;</span>, use_label_encoder<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>model.set_params(base_score<span class="op">=</span><span class="fl">0.5</span>, booster<span class="op">=</span><span class="st">&#39;gbtree&#39;</span>,</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>              colsample_bylevel<span class="op">=</span><span class="dv">1</span>, colsample_bynode<span class="op">=</span><span class="dv">1</span>, colsample_bytree<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>              gamma<span class="op">=</span><span class="dv">0</span>, gpu_id<span class="op">=-</span><span class="dv">1</span>, importance_type<span class="op">=</span><span class="st">&#39;gain&#39;</span>,</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>              interaction_constraints<span class="op">=</span><span class="st">&#39;&#39;</span>, learning_rate<span class="op">=</span><span class="fl">0.300000012</span>,</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>              max_delta_step<span class="op">=</span><span class="dv">0</span>, max_depth<span class="op">=</span><span class="dv">6</span>, min_child_weight<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>              monotone_constraints<span class="op">=</span><span class="st">&#39;()&#39;</span>, n_estimators<span class="op">=</span><span class="dv">100</span>, n_jobs<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>              num_parallel_tree<span class="op">=</span><span class="dv">1</span>, random_state<span class="op">=</span><span class="dv">0</span>, reg_alpha<span class="op">=</span><span class="dv">0</span>, reg_lambda<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>              scale_pos_weight<span class="op">=</span><span class="dv">1</span>, subsample<span class="op">=</span><span class="dv">1</span>, tree_method<span class="op">=</span><span class="st">&#39;exact&#39;</span>,</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>              validate_parameters<span class="op">=</span><span class="dv">1</span>, verbosity<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_smote, y_train_smote)</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="output stream stdout">
<pre><code>[23:19:02] WARNING: ../src/learner.cc:516: 

Parameters: { use_label_encoder } might not be used.



  This may not be accurate due to some parameters are only used in language bindings but

  passed down to XGBoost core.  Or some parameters are not used but slip through this

  verification. Please open an issue if you find above cases.




</code></pre>
</div>
<div class="output execute_result" data-execution_count="270">
<pre><code>XGBClassifier(base_score=0.5, booster=&#39;gbtree&#39;, colsample_bylevel=1,
              colsample_bynode=1, colsample_bytree=1, eval_metric=&#39;auc&#39;,
              gamma=0, gpu_id=-1, importance_type=&#39;gain&#39;,
              interaction_constraints=&#39;&#39;, learning_rate=0.300000012,
              max_delta_step=0, max_depth=6, min_child_weight=1, missing=nan,
              monotone_constraints=&#39;()&#39;, n_estimators=100, n_jobs=0,
              num_parallel_tree=1, random_state=0, reg_alpha=0, reg_lambda=1,
              scale_pos_weight=1, subsample=1, tree_method=&#39;exact&#39;,
              use_label_encoder=False, validate_parameters=1, verbosity=None)</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="271">
<div class="sourceCode" id="cb77"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict_proba(X_test)[:,<span class="dv">1</span>]</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>fp_r, tp_r, t <span class="op">=</span> metrics.roc_curve(y_test, y_pred)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>auc <span class="op">=</span> metrics.auc(fp_r, tp_r)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>plt.plot(fp_r, tp_r, label<span class="op">=</span><span class="st">&quot;AUC = </span><span class="sc">%.2f</span><span class="st">&quot;</span> <span class="op">%</span> auc)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>,<span class="dv">1</span>],[<span class="dv">0</span>,<span class="dv">1</span>],<span class="st">&quot;r--&quot;</span>)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;TP rate&quot;</span>)</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;FP rate&quot;</span>)</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;ROC Curve&quot;</span>)</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_8a8eb62ffdfe4e549465fa0e38037da9/c37bd5c645efa55ae64698ad45abebbc89aeba5f.png" /></p>
</div>
</div>
<div class="cell markdown">
<p>The perfromance was rather decreased with oversampling.</p>
</div>
<div class="cell code">
<div class="sourceCode" id="cb78"><pre
class="sourceCode python"><code class="sourceCode python"></code></pre></div>
</div>
</body>
</html>
